{"name":"Antiflood","tagline":"Kohana module for anti flood protection","body":"# Antiflood module for Kohana Framework\r\n\r\nThis module can be used to protect Your application against too many requests.\r\nIt can not protect against DDoS attacks.\r\n\r\nThis is a derivative work based on:\r\n\r\nhttps://github.com/damog/planetalinux/blob/master/www/principal/suscripcion/lib/antiflood.hack.php\r\n\r\n\r\n## Information\r\n\r\nYour project have following structure if You use default file driver\r\n\r\n```\r\n application\r\n   control\r\n     antiflood\r\n modules\r\n   antiflood\r\n system\r\n index.php\r\n```\r\n\r\nYou must create antiflood control dir from Your antiflood config file. Default\r\nis: application/control/antiflood. You can use the same control dir for the\r\ndifferent request URI.\r\n\r\n## Additional information\r\n\r\nYou must set DOCROOT in Your index.php\r\n\r\n` define('DOCROOT', realpath(dirname(__FILE__)).DIRECTORY_SEPARATOR); `\r\n\r\nAdd:\r\n\r\n` 'antiflood' => MODPATH . 'antiflood' `\r\n\r\nto Your bootstrap.php\r\n\r\n## Requirements\r\n\r\nThe redis driver requires predis library:\r\nhttps://github.com/nrk/predis\r\n\r\nInstall this library on:\r\n\r\napplication/vendor\r\n\r\nautoload.php must be in:\r\n\r\napplication/vendor/predis\r\n\r\nThis library is internal included included by:\r\n\r\n```php\r\nrequire_once Kohana::find_file('vendor/predis', 'autoload');\r\n```\r\nNo need to install Redis PHP extension module.\r\n\r\n## Example usage:\r\n\r\nUsing default file driver:\r\n\r\n```php\r\n\r\n $antiflood = Antiflood::instance();\r\n if ($antiflood->check())\r\n {\r\n     $antiflood->count_requests();\r\n     $this->template = View::factory('welcome/index');\r\n }\r\n else\r\n {\r\n     header('HTTP/1.1 503 Service Unavailable');\r\n     die();\r\n }\r\n\r\n```\r\n\r\nUsing sqlite driver:\r\n\r\n```php\r\n\r\n $antiflood = Antiflood::instance('sqlite');\r\n if ($antiflood->check())\r\n {\r\n     $antiflood->count_requests();\r\n     $this->template = View::factory('welcome/index');\r\n }\r\n else\r\n {\r\n     header('HTTP/1.1 503 Service Unavailable');\r\n     die();\r\n }\r\n\r\n```\r\n\r\n## Probablistic garbage collection\r\n\r\n```php\r\n$antiflood = Antiflood::instance();\r\n\r\n// Set a GC probability of 10%\r\n$gc = 10;\r\n\r\n// If the GC probability is a hit\r\nif (rand(0, 99) < $gc and $antiflood instanceof Antiflood_GarbageCollect)\r\n{\r\n    // Garbage Collect\r\n    $antiflood->garbage_collect();\r\n}\r\n```\r\n\r\nThe garbage collector uses expiration config value to delete old and not used\r\nrecords.\r\n\r\n## Config\r\n\r\nantiflood.php\r\n\r\n```php\r\n<?php\r\n\r\ndefined('SYSPATH') or die('No direct script access.');\r\n\r\nreturn array(\r\n    'file' => array(\r\n        'driver' => 'file',\r\n        'control_dir' => APPPATH . 'control/antiflood',\r\n        'control_key' => $_SERVER['REMOTE_ADDR'] . $_SERVER['REQUEST_URI'],\r\n        'control_max_requests' => 3,\r\n        'control_request_timeout' => 3600,\r\n        'control_ban_time' => 20,\r\n        'expiration' => 172800\r\n    ),\r\n    'sqlite' => array(\r\n        'driver' => 'sqlite',\r\n        'database' => APPPATH . 'control/antiflood/kohana-antiflood.sql3',\r\n        'schema' => 'CREATE TABLE controls(id integer PRIMARY KEY AUTOINCREMENT, control_key varchar(255), last_access datetime, requests INTEGER, locked INTEGER, locked_access datetime)',\r\n        'control_key' => $_SERVER['REMOTE_ADDR'] . $_SERVER['REQUEST_URI'],\r\n        'control_max_requests' => 3,\r\n        'control_request_timeout' => 3600,\r\n        'control_ban_time' => 20,\r\n        'expiration' => 172800\r\n    ),\r\n    'mysql' => array(\r\n        'driver' => 'mysql',\r\n        'hostname' => 'localhost',\r\n        'database' => 'mojastrona',\r\n        'username' => 'root',\r\n        'password' => 'root',\r\n        'schema' =>\r\n        'CREATE TABLE controls (' .\r\n        'id int(10) unsigned NOT NULL AUTO_INCREMENT,' .\r\n        'control_key varchar(255) NOT NULL,' .\r\n        'last_access INT(11) NOT NULL,' .\r\n        'requests int(10) unsigned NOT NULL,' .\r\n        'locked tinyint(1) NOT NULL,' .\r\n        'locked_access INT(11) NOT NULL,' .\r\n        'PRIMARY KEY (id)' .\r\n        ') ENGINE=InnoDB DEFAULT CHARSET=utf8;',\r\n        'control_key' => $_SERVER['REMOTE_ADDR'] . $_SERVER['REQUEST_URI'],\r\n        'control_max_requests' => 3,\r\n        'control_request_timeout' => 3600,\r\n        'control_ban_time' => 20,\r\n        'expiration' => 172800\r\n    ),\r\n    'postgresql' => array(\r\n        'driver' => 'postgresql',\r\n        'hostname' => 'localhost',\r\n        'database' => 'finance',\r\n        'username' => 'postgres',\r\n        'password' => 'postgres',\r\n        'schema' =>\r\n        'CREATE TABLE controls' .\r\n        '(' .\r\n        '  id serial NOT NULL,' .\r\n        '  control_key character varying(255) NOT NULL,' .\r\n        '  last_access bigint NOT NULL,' .\r\n        '  requests integer NOT NULL,' .\r\n        '  locked integer NOT NULL,' .\r\n        '  locked_access bigint NOT NULL,' .\r\n        '  CONSTRAINT pk_controls PRIMARY KEY (id)' .\r\n        ')',\r\n        'control_key' => $_SERVER['REMOTE_ADDR'] . $_SERVER['REQUEST_URI'],\r\n        'control_max_requests' => 3,\r\n        'control_request_timeout' => 3600,\r\n        'control_ban_time' => 600,\r\n        'expiration' => 172800\r\n    ),\r\n    'redis' => array(\r\n        'driver' => 'redis',\r\n        'control_key' => $_SERVER['REMOTE_ADDR'] . $_SERVER['REQUEST_URI'],\r\n        'control_max_requests' => 3,\r\n        'control_request_timeout' => 3600,\r\n        'control_ban_time' => 600,\r\n        'host' => '127.0.0.1',\r\n        'port' => 6379,\r\n        'database' => 15\r\n    ),\r\n    'memcache' => array(\r\n        'driver' => 'memcache',\r\n        'control_key' => $_SERVER['REMOTE_ADDR'] . $_SERVER['REQUEST_URI'],\r\n        'control_max_requests' => 3,\r\n        'control_request_timeout' => 3600,\r\n        'control_ban_time' => 600,\r\n        'compression' => FALSE, // Use Zlib compression (can cause issues with integers)\r\n        'servers' => array(\r\n            'local' => array(\r\n                'host' => 'localhost', // Memcache Server\r\n                'port' => 11211, // Memcache port number\r\n                'persistent' => FALSE, // Persistent connection\r\n                'weight' => 1,\r\n                'timeout' => 1,\r\n                'retry_interval' => 15,\r\n                'status' => TRUE\r\n            ),\r\n        ),\r\n        // Take server offline immediately on first fail (no retry)\r\n        'instant_death' => TRUE\r\n    )\r\n);\r\n\r\n```\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}